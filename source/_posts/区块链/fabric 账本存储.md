---
title: "区块链Fabric数据存储结构"
top: true
date:  2019-08-28 10:33:03
categories: 区块链
tags:
- fabric
---

本文主要介绍区块链Fabric数据存储结构。

## Fabric 数据存储结构

### 账本

#### 概述

Hyperledger Fabric支持多链。每个链对应一套账本。所以区块链每个peer节点会维护多套账本。每个账本包含以下元素：

+ 账本编号：快速查询存在哪些账本
+ 账本数据：实际的区块数据存储
+ 区块索引：快速查询区块／交易
+ 状态数据：最新的世界状态数据
+ 历史数据：跟踪键的历史

每个peer节点会维护4个DB，它们分别是：

+ idStore（ledgerID数据库）
+ blockIndex（存储区块文件索引）
+ statedb（状态数据库）
+ historydb（历史数据库)

其中，ledgerID数据库存储chainID，用于快速查询节点存在哪些账本。状态数据库存储的是所有曾经在交易中出现的键值对的最新值。历史状态数据库用于查询某个key的历史修改记录。而账本数据基于文件系统实现，将区块存储在文件块中，然后在区块索引LevelDB中存储区块交易对应的文件块及其偏移，即将区块索引LevelDB作为账本数据的索引。

![img](../../../../../../../Desktop/13904308-6f30e3482bf3b5d1.png)

其中，世界状态数据库和账本数据是账本最重要的两个组成部分，后续将详细介绍，如图所示。

![ledger.ledger](../../../../../../../Desktop/ledger.diagram.1.png)



#### 状态数据库

状态数据库存储的是所有曾经在交易中出现的键值对的最新值。调用链码执行交易可以改变状态数据，为了高效的执行链码调用，所有数据的最新值都被存放在状态数据库中；状态数据库是有序交易日志的快照，任何时候都可以根据交易日志重新生成状态数据库；状态数据库会在Peer节点启动的时候自动恢复或重构。状态数据库目前支持LevelDB和CouchDB：

+ LevelDB（默认的KV数据库）：支持键的查询，组合键的查询、范围键的查询。
+ CouchDB（可选的KV数据库）：支持键的查询、组合件的查询，还有复杂的查询。

不同账本的状态数据库存放在不同的目录下，不同链码的数据是按链码编号（chaincodeID）作为命名空间来划分数据。状态数据库的基本操作是基于键值对的管理。读取状态数据的时候不用指定版本，读取到的状态数据是某个时刻最新的版本，返回的数据包含版本和数据两个部分。如图所示。

![ledger.worldstate](../../../../../../../Desktop/ledger.diagram.3.png)

> *一个账本世界状态包含两个状态。第一个状态是： key=CAR1 和 value=Audi。第二个状态中有一个更复杂的值：key=CAR2 和 value={model:BMW, color=red, owner=Jane} 。两个状态的版本都是0。*

#### 账本数据结构介绍

账本数据以二进制文件的形式存储的，每个账本数据存储在不同的目录下。账本数据的所有操作都通过区块文件管理器实现。区块文件管理器创建的文件以blockfile_为前缀，6位数字为后缀，后缀必须是从小到大连续的数字，中间不能有缺失，因此账本最大可以持有1000000个文件块。默认的区块文件块大小的上限是64M（目前硬编码在代码中）。账本数据的结构如下：

![ledger.blockchain](../../../../../../../Desktop/ledger.diagram.2.png)

在上图中 B代表区块链账本数据。其中B0为创世区块，其中包含了区块头H0，区块数据D0（创世区块里不包含交易数据），区块元数据M0。区块B1区块头H1，其中包含了前一个区块B0的加密hash和本身区块的加密hash，区块B1的区块数据D1包含交易T1、T2、T3、及T4。

