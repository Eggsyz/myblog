---
title: "区块链Fabric架构介绍"
date:  2020-04-18 10:33:03
categories: 区块链
tags:
- fabric
---

本文主要基于《区块链原理、设计与应用》这本书介绍区块链Fabric架构。

## Fabric 架构介绍

### Fabric架构的核心特性

目前，超级账本Fabric架构的核心特性主要包括：

+ 解耦了原子排序环节与其他复杂处理环节，消除了网络处理瓶颈，提高可扩展性；

+ 解耦交易处理节点的逻辑角色为背书节点（Endorser）、确认节点（Committer），可以根据负载进行灵活部署；

+ 加强了身份证书管理服务，作为单独的Fabric CA项目，提供更多功能；

+ 支持多通道特性，不同通道之间的数据彼此隔离，提高隔离安全性；

+ 支持可拔插的架构，包括共识、权限管理、加解密、账本机制等模块，支持多种类型；

+ 引入系统链码来实现区块链系统的处理，支持可编程和第三方实现。

### Fabric 逻辑架构

Fabric逻辑架构如图所示，

<img src="https://wx1.sbimg.cn/2020/04/30/07fd0e2a56038c9050ab3ffc449bc0f5.png" alt="07fd0e2a56038c9050ab3ffc449bc0f5.png" style="zoom:50%;" />

Fabric逻辑架构根据不同角度进行划分，上层基于应用程序角度进行设计，包括SDK、API、事件，通过SDK、API、事件来对底层区块链进行操作：包括身份管理、账本管理、交易管理、智能合约的部署和调用；下层基于底层区块链进行设计，对外提供成员管理服务、共识服务、链码服务、安全和密码服务。Fabric为应用提供了gRPC API，以及封装API的SDK供应用调用。应用可以通过SDK访问Fabric网络中的多种资源，包括账本、交易、链码、事件、权限管理等。

#### 应用层逻辑架构

（1）成员
联盟链考虑到商业应用对安全、隐私、监管、审计、性能的需求，提高准入门槛，成员必须被许可才能加入网络。Fabric成员管理服务为整个区块链网络提供身份管理、隐私、保密和可审计的服务。成员管理服务通过公钥基础设施PKI和去中心化共识机制使得非许可的区块链变成许可制的区块链。
（2）账本
授权的用户是可以查询账本数据的，可以通过多种方式查询，包括：
A、根据区块号查询区块
B、根据区块哈希查询区块
C、根据交易号查询区块
D、根据交易号查询交易
E、根据通道名称查询区块链信息
（3）交易
账本数据只能通过发送交易进行更新，客户端通过提交交易提案(Proposal)给背书节点背书，在获取到足够数量交易背书(Endorsement)后，再给排序服务节点提交交易，排序服务将批量交易打包生成区块。
（4）智能合约
Fabric的智能合约（Smart Contract）称为链码（ChainCode）。Fabric通过智能合约实现了可编程的账本，通过链码执行提交的交易，实现基于区块链的智能合约业务逻辑。

#### 底层逻辑架构

（1）成员服务管理
MSP（Member Service Provider）成员服务模块对成员管理进行了抽象，提供包括会员注册，身份保护、内容保密、交易审计等功能，可以使用可插拔的Fabric-CA模块或第三方的CA来代替。
（2）共识服务
共识服务负责节点间共识管理、账本的分布式计算、账本的存储及节点间的P2P协议功能的实现，是区块链的核心组成部分，为区块链的主体功能提供了底层技术支撑
（3）链码服务
链码服务为智能合约实现提供了一系列接口，并为链码的安装、运行、部署提供了环境。智能合约的实现依赖于安全的执行环境，确保安全的执行过程和用户数据的隔离。Fabric采用Docker管理普通的链码，提供安全的沙箱环境和镜像文件仓库，可支持多种语言的链码。
（4）安全和密码服务
安全问题是企业级区块链关心的问题，Hyperledger Fabric专门定义了一个BCCSP（BlockChain Cryptographic Service Provider）模块，实现密钥生成、哈希运算、签名验签、加密解密等基础功能。

### Fabric 网络架构

 Fabric网络是通过组织来划分的，每个组织内都包含承担不同功能的Peer 节点，每个Peer节点又可以担任多种角色。所有的组织共用一个统一的Orderer排序服务集群。其基本架构如图所示：

<img src="https://wx1.sbimg.cn/2020/04/30/dd7a3f65edf0b0c5a625b3f01ee4d838.png" alt="dd7a3f65edf0b0c5a625b3f01ee4d838.png" style="zoom:50%;" />

每个组织通常拥有自己的客户端、Peer节点和CA节点，并且可以根据需要创建一个或多个不同的类型节点。Orderer节点不属于某个组织的实体，属于组织共同维护的节点。

#### Peer节点

Fabric区块链网络中的每个组织可以拥有一到多个Peer节点。每个Peer节点可以担任多种角色：Endorser Peer（背书节点）、Leader Peer（主节点）、Committer Peer（记账节点）、Anchor Peer（锚节点）。
每个Peer节点必定是一个记账节点，除记账节点外，也可以担任其它一到多种角色，即某个Peer节点可以同时是记账节点和背书节点，也可以同时是记账节点、背书节点、主节点，锚节点。
（1）Endorser Peer（背书节点）
 背书节点是动态的角色，是与具体链码绑定的。每个链码在实例化的时候都会设置背书策略(Endorsement policy)，指定哪些节点对交易背书才有效。
（2）Leader Peer（主节点）
   主节点负责和Orderer排序服务节点通信，从排序服务节点处获取最新的区块并在组织内部同步。可以强制设置，也可以选举产生。
（3）Committer Peer（记账节点）
 负责验证从排序服务节点接收的区块里的交易，然后将区块提交（写入/追加）到其通道账本的副本。记账节点还将每个块中的每个交易标记为有效或无效。
（4）Anchor Peer（锚节点）
 在一个通道上可以被所有其它Peer节点发现的Peer节点，通道上的每个成员都有一个Anchor Peer，允许属于不同成员的Peer节点发现通道上的所有现有Peer节点。

#### Orderer 节点

排序服务节点接收包含背书签名的交易，对未打包的交易进行排序生成区块，广播给Peer节点。排序服务提供的是原子广播，保证同一个链上的节点为接收到相同的消息，并且有相同的逻辑顺序。排序服务独立于Peer进程存在并且对Fabric网络上的所有通道进行排序交易。排序服务节点按照一定规则确定交易顺序后，将交易打包成区块发给各个记账节点，把交易持久化到区块链的账本中。